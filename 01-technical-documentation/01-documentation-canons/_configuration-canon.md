# Canon: Configuration Documentation

## Purpose

Configuration documentation provides complete reference for all configuration parameters, environment variables, feature flags, and system settings. It enables rapid environment setup, troubleshooting, and ensures consistent configuration across environments.

---

## Scope

**This canon applies to:**
- Environment variables
- Application configuration files
- Feature flags
- System settings and tunables
- Third-party service configurations
- Environment-specific configurations (dev, staging, production)

**This canon does NOT apply to:**
- Code configuration (use code documentation)
- Infrastructure configuration (use deployment documentation)
- Secrets management (use security documentation for procedures)

---

## Access Level Classification

**Configuration Documentation:**
- **Access Level:** Internal (Level 2)
- **Distribution:** Development team, DevOps team, system administrators
- **Storage:** Private repository with authentication
- **Review:** DevOps review, security clearance for sensitive parameters
- **Rationale:** Contains system internals, integration details, potential security implications

**Note:** Actual secret values (API keys, passwords) are NOT documented here. Only parameter names and purposes.

---

## When to Generate

### Initial Creation
- **Environment Setup:** When creating new environment
- **New Service:** When adding new microservice
- **Integration:** When integrating external services

### Updates
- After adding new configuration parameters
- After changing configuration structure
- After environment-specific changes
- Monthly review for accuracy

### Frequency
- **Initial:** During environment setup
- **Configuration Changes:** Every parameter addition/removal
- **Regular Review:** Monthly for accuracy
- **Before Deployment:** Verify configuration documentation current

---

## Files to Generate

Agent must create the following files when documenting configuration:

### 1. Configuration Index
**File:** `/docs/source/configuration/00-index.rst`  
**Format:** reStructuredText  
**Purpose:** Configuration documentation entry point

### 2. Environment Variables Reference
**File:** `/docs/source/configuration/01-environment-variables.rst`  
**Format:** reStructuredText  
**Purpose:** Complete reference for all environment variables

### 3. Configuration Files
**File:** `/docs/source/configuration/02-configuration-files.rst`  
**Format:** reStructuredText  
**Purpose:** Application configuration file formats and parameters

### 4. Feature Flags
**File:** `/docs/source/configuration/03-feature-flags.rst`  
**Format:** reStructuredText  
**Purpose:** Feature flag definitions and usage

### 5. Environment-Specific Settings
**File:** `/docs/source/configuration/04-environment-settings.rst`  
**Format:** reStructuredText  
**Purpose:** Configuration differences across environments

---

## Directory Structure

```
docs/source/configuration/
├── 00-index.rst                    # Configuration documentation entry point
├── 01-environment-variables.rst    # Environment variable reference
├── 02-configuration-files.rst      # Configuration file formats
├── 03-feature-flags.rst            # Feature flag reference
└── 04-environment-settings.rst     # Environment-specific configuration
```

---

## Generation Rules

### Environment Variable Documentation

For each environment variable, document:

1. **Name** - Exact variable name
2. **Type** - String, integer, boolean, JSON
3. **Required** - Yes or no
4. **Default** - Default value if not set
5. **Description** - Purpose and usage
6. **Example** - Sample value (NOT production secrets)
7. **Environment** - Which environments use this variable

### Secrets Handling

**Never document actual secret values.**

Document:
- Variable name
- Purpose
- Format expected
- Where to obtain (e.g., "Generated by AWS Secrets Manager")

Do NOT document:
- Actual API keys
- Actual passwords
- Actual tokens

### Table Format

Use tables for environment variables:

```rst
.. list-table::
   :header-rows: 1
   :widths: 20 10 10 15 45

   * - Variable
     - Type
     - Required
     - Default
     - Description
   * - ``DATABASE_URL``
     - String
     - Yes
     - 
     - PostgreSQL connection string
```

### Writing Style

Follow `00-core-canons/_core_canon.md` rules:
- No emojis, no emdashes
- Active voice
- Specific over vague (exact parameter names, formats)
- **Tables are appropriate** for configuration parameters

---

## Content Guidelines

### Configuration Index (`/docs/source/configuration/00-index.rst`)

```rst
Configuration Documentation
===========================

.. warning::
   INTERNAL DOCUMENTATION - Level 2 Access
   This documentation contains configuration parameter details.
   Do not share with external parties.

.. contents::
   :local:
   :depth: 2

Overview
--------

Configuration is managed through environment variables and configuration files.

**Priority Order** (highest to lowest):
1. Environment variables (highest priority)
2. Configuration files (`config.yaml`)
3. Default values in code

Configuration Files
-------------------

**Development**: ``.env.local`` (not committed to Git)  
**Staging**: Environment variables in Kubernetes ConfigMap  
**Production**: Environment variables in Kubernetes ConfigMap + AWS Secrets Manager

Quick Reference
---------------

- **Environment Variables**: :doc:`01-environment-variables`
- **Configuration Files**: :doc:`02-configuration-files`
- **Feature Flags**: :doc:`03-feature-flags`
- **Environment Settings**: :doc:`04-environment-settings`

.. toctree::
   :maxdepth: 2

   01-environment-variables
   02-configuration-files
   03-feature-flags
   04-environment-settings

Configuration Best Practices
-----------------------------

**Do:**
- Store secrets in AWS Secrets Manager (not environment variables)
- Use meaningful variable names
- Document all configuration parameters
- Provide sensible defaults

**Don't:**
- Commit secrets to Git
- Hard-code configuration in application code
- Use ambiguous variable names
```

### Environment Variables (`/docs/source/configuration/01-environment-variables.rst`)

```rst
Environment Variables Reference
================================

Complete reference for all environment variables used by the system.

Database Configuration
----------------------

.. list-table::
   :header-rows: 1
   :widths: 20 10 10 15 45

   * - Variable
     - Type
     - Required
     - Default
     - Description
   * - ``DATABASE_URL``
     - String
     - Yes
     - 
     - PostgreSQL connection string. Format: ``postgres://user:password@host:port/database``
   * - ``DB_POOL_SIZE``
     - Integer
     - No
     - ``20``
     - Maximum database connection pool size
   * - ``DB_POOL_TIMEOUT``
     - Integer
     - No
     - ``5000``
     - Connection pool timeout in milliseconds
   * - ``DB_SSL_MODE``
     - String
     - No
     - ``require``
     - PostgreSQL SSL mode (``disable``, ``require``, ``verify-ca``, ``verify-full``)

**Example** (Development):

.. code-block:: bash

   export DATABASE_URL="postgres://dev:devpass@localhost:5432/tms_dev"
   export DB_POOL_SIZE=10

Redis Configuration
-------------------

.. list-table::
   :header-rows: 1
   :widths: 20 10 10 15 45

   * - Variable
     - Type
     - Required
     - Default
     - Description
   * - ``REDIS_URL``
     - String
     - Yes
     - 
     - Redis connection string. Format: ``redis://host:port``
   * - ``REDIS_PASSWORD``
     - String
     - No
     - 
     - Redis password (if authentication enabled)
   * - ``REDIS_TTL``
     - Integer
     - No
     - ``300``
     - Default cache TTL in seconds

**Example** (Development):

.. code-block:: bash

   export REDIS_URL="redis://localhost:6379"
   export REDIS_TTL=600

Application Configuration
-------------------------

.. list-table::
   :header-rows: 1
   :widths: 20 10 10 15 45

   * - Variable
     - Type
     - Required
     - Default
     - Description
   * - ``NODE_ENV``
     - String
     - Yes
     - ``development``
     - Application environment (``development``, ``staging``, ``production``)
   * - ``PORT``
     - Integer
     - No
     - ``3000``
     - HTTP server port
   * - ``LOG_LEVEL``
     - String
     - No
     - ``info``
     - Logging level (``debug``, ``info``, ``warn``, ``error``)
   * - ``CORS_ORIGIN``
     - String
     - No
     - ``*``
     - Allowed CORS origins (comma-separated)

**Example** (Production):

.. code-block:: bash

   export NODE_ENV=production
   export PORT=8080
   export LOG_LEVEL=warn
   export CORS_ORIGIN="https://app.example.com"

Authentication Configuration
----------------------------

.. list-table::
   :header-rows: 1
   :widths: 20 10 10 15 45

   * - Variable
     - Type
     - Required
     - Default
     - Description
   * - ``JWT_SECRET``
     - String
     - Yes
     - 
     - Secret key for JWT signing (obtain from AWS Secrets Manager)
   * - ``JWT_EXPIRY``
     - Integer
     - No
     - ``900``
     - JWT access token expiry in seconds (default: 15 minutes)
   * - ``REFRESH_TOKEN_EXPIRY``
     - Integer
     - No
     - ``604800``
     - Refresh token expiry in seconds (default: 7 days)

**Security Note**: ``JWT_SECRET`` must be cryptographically secure random string (minimum 256 bits).

**Example**:

.. code-block:: bash

   export JWT_EXPIRY=900  # 15 minutes
   export REFRESH_TOKEN_EXPIRY=604800  # 7 days
   # JWT_SECRET loaded from AWS Secrets Manager (not environment variable)

Third-Party Integrations
-------------------------

.. list-table::
   :header-rows: 1
   :widths: 20 10 10 15 45

   * - Variable
     - Type
     - Required
     - Default
     - Description
   * - ``KRA_API_URL``
     - String
     - Yes (production)
     - 
     - KRA eTIMS API base URL
   * - ``KRA_API_KEY``
     - String
     - Yes (production)
     - 
     - KRA API key (obtain from AWS Secrets Manager)
   * - ``MPESA_API_URL``
     - String
     - Yes (if payments enabled)
     - 
     - M-Pesa API base URL
   * - ``MPESA_CONSUMER_KEY``
     - String
     - Yes (if payments enabled)
     - 
     - M-Pesa consumer key (obtain from AWS Secrets Manager)
   * - ``SENDGRID_API_KEY``
     - String
     - Yes (if emails enabled)
     - 
     - SendGrid API key for email delivery

**Example** (Staging):

.. code-block:: bash

   export KRA_API_URL="https://sandbox.kra.go.ke/etims/api"
   # KRA_API_KEY loaded from AWS Secrets Manager

Complete Variable List
----------------------

Total environment variables:

- **Database**: 4 variables
- **Redis**: 3 variables
- **Application**: 4 variables
- **Authentication**: 3 variables
- **Third-Party**: 6 variables

**Total**: 20 environment variables
```

### Feature Flags (`/docs/source/configuration/03-feature-flags.rst`)

```rst
Feature Flags
=============

Feature flags enable gradual rollout and A/B testing.

Feature Flag System
-------------------

**Implementation**: LaunchDarkly  
**Evaluation**: Server-side (backend evaluates flags)  
**Default**: All flags default to ``false`` (safe default)

Active Feature Flags
--------------------

**TAX_CALCULATION_V2**

**Purpose**: Enable new tax calculation algorithm  
**Type**: Killswitch (can disable if issues detected)  
**Status**: 50% rollout (staging: 100%, production: 50%)  
**Owner**: Tax Team  
**Metrics**: Track calculation accuracy, performance

**Values:**
- ``true``: Use new algorithm
- ``false``: Use legacy algorithm

**MFA_ENFORCEMENT**

**Purpose**: Enforce multi-factor authentication for all users  
**Type**: Gradual rollout  
**Status**: Admins only (staging: all users, production: admins only)  
**Owner**: Security Team  
**Target**: 100% by Q2 2026

**Values:**
- ``true``: MFA required
- ``false``: MFA optional

**RECEIPT_EXPORT_PDF**

**Purpose**: Enable PDF export of receipts  
**Type**: Feature flag  
**Status**: 100% (enabled for all)  
**Owner**: Product Team

**Values:**
- ``true``: PDF export available
- ``false``: PDF export hidden

Feature Flag Usage
------------------

**Backend (Go):**

.. code-block:: go

   import "github.com/launchdarkly/go-server-sdk/v6/ldclient"

   func calculateTax(user User, salary float64) float64 {
       useV2, _ := ldClient.BoolVariation("TAX_CALCULATION_V2", user.toLDUser(), false)
       if useV2 {
           return calculateTaxV2(salary)
       }
       return calculateTaxLegacy(salary)
   }

**Frontend (React):**

.. code-block:: javascript

   import { useFlags } from 'launchdarkly-react-client-sdk';

   function ReceiptActions() {
       const { receiptExportPdf } = useFlags();

       return (
           <div>
               {receiptExportPdf && (
                   <button onClick={exportPdf}>Export PDF</button>
               )}
           </div>
       );
   }

Retired Feature Flags
---------------------

Remove feature flags after full rollout:

**MOBILE_APP_BETA** (retired Dec 2025)
- **Reason**: Mobile app launched to 100%
- **Action**: Code cleaned up, flag removed

**NEW_DASHBOARD_UI** (retired Nov 2025)
- **Reason**: New dashboard stable for 3 months
- **Action**: Old dashboard code removed
```

### Environment-Specific Settings (`/docs/source/configuration/04-environment-settings.rst`)

```rst
Environment-Specific Settings
==============================

Configuration differences across environments.

Environment Overview
--------------------

.. list-table::
   :header-rows: 1
   :widths: 20 25 25 30

   * - Setting
     - Development
     - Staging
     - Production
   * - Database
     - Local PostgreSQL
     - AWS RDS (t3.medium)
     - AWS RDS (r5.xlarge)
   * - Redis
     - Local Redis
     - ElastiCache (t3.small)
     - ElastiCache (r5.large)
   * - Log Level
     - ``debug``
     - ``info``
     - ``warn``
   * - CORS
     - ``*`` (all origins)
     - Specific domains
     - Production domain only

Development Environment
-----------------------

**Purpose**: Local development on developer machines

**Key Differences:**
- All services run in Docker Compose
- Debug logging enabled
- CORS allows all origins
- No authentication for some endpoints (for testing)
- Seed data automatically loaded

**Environment Variables:**

.. code-block:: bash

   NODE_ENV=development
   DATABASE_URL=postgres://dev:devpass@localhost:5432/tms_dev
   REDIS_URL=redis://localhost:6379
   LOG_LEVEL=debug
   CORS_ORIGIN=*

Staging Environment
-------------------

**Purpose**: Pre-production testing, mirrors production

**Key Differences:**
- Uses AWS infrastructure (smaller instances)
- Connects to KRA sandbox API
- Uses test M-Pesa credentials
- Emails sent to test inbox (no real customers)
- Feature flags at 100% (test before production rollout)

**Environment Variables:**

.. code-block:: bash

   NODE_ENV=staging
   DATABASE_URL=postgres://[REDACTED]@staging-db.internal:5432/tms_staging
   REDIS_URL=redis://staging-redis.internal:6379
   LOG_LEVEL=info
   CORS_ORIGIN=https://staging.example.com
   KRA_API_URL=https://sandbox.kra.go.ke/etims/api

Production Environment
----------------------

**Purpose**: Live system serving real customers

**Key Differences:**
- Full AWS infrastructure with auto-scaling
- Connects to KRA production API
- Real M-Pesa credentials
- Emails sent to real customers
- Feature flags gradual rollout
- Comprehensive monitoring and alerting

**Environment Variables:**

.. code-block:: bash

   NODE_ENV=production
   # DATABASE_URL loaded from AWS Secrets Manager
   # REDIS_URL loaded from AWS Secrets Manager
   LOG_LEVEL=warn
   CORS_ORIGIN=https://app.example.com
   KRA_API_URL=https://api.kra.go.ke/etims/api

**Security**: All secrets loaded from AWS Secrets Manager, not environment variables.

Configuration Drift Detection
------------------------------

**Weekly Check**: Compare configuration across environments

**Tool**: ``config-diff`` script

.. code-block:: bash

   # Check for configuration drift
   ./scripts/config-diff.sh staging production

**Alert**: Notify DevOps team if unexpected drift detected
```

---

## Validation

Agent must validate documentation before completion:

### reStructuredText Validation

```bash
# Validate all configuration reST files
rstcheck docs/source/configuration/*.rst
```

**Expected output:** No errors

### Configuration Completeness

- [ ] All environment variables documented
- [ ] All feature flags documented
- [ ] Environment-specific differences clear
- [ ] No actual secrets included in documentation

### Sphinx Build Validation

```bash
# Build documentation with warnings as errors
sphinx-build -W -b html docs/source docs/build
```

**Expected output:** Build succeeds without warnings

---

## Examples Reference

See working example: `02-examples/configuration-example/` (to be created)

**Example includes:**
- Complete configuration documentation
- Environment variable reference
- Feature flag examples

---

## Access Level Warning

Include at top of `00-index.rst`:

```rst
.. warning::
   INTERNAL DOCUMENTATION - Level 2 Access
   This documentation contains configuration parameter details.
   Do not share with external parties.
```

---

## Agent Checklist

Before marking configuration documentation complete, verify:

- [ ] Configuration index created
- [ ] All environment variables documented
- [ ] Configuration file formats documented
- [ ] All feature flags documented with owners
- [ ] Environment-specific settings documented
- [ ] No actual secret values included
- [ ] Tables used for parameter listings
- [ ] Access level warnings included
- [ ] Sphinx build succeeds without warnings
- [ ] No emojis or emdashes present

---

## Version History

**Version 1.0 - December 29, 2025**
- Initial configuration documentation canon
- Based on 12-factor app principles
- Follows `_docs-canon.md` v4 specifications
