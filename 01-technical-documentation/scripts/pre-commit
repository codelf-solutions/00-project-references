#!/usr/bin/env bash
#
# Pre-commit hook for documentation validation
# Validates changed documentation files before commit
#
# Installation:
#   cp scripts/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit

# Get list of changed files
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

ERRORS=0

echo "Pre-commit Documentation Validation"
echo "===================================="

# Check for emojis
if echo "$CHANGED_FILES" | grep -E '\.(rst|md)$' | xargs grep -l "ðŸ˜€\|ðŸ˜\|ðŸ˜‚\|ðŸŽ‰\|âœ…\|âŒ\|âš ï¸" 2>/dev/null; then
    echo -e "${RED}âœ— Emojis found in documentation (violates core canon)${NC}"
    ((ERRORS++))
fi

# Check for emdashes
if echo "$CHANGED_FILES" | grep -E '\.(rst|md)$' | xargs grep -l "â€”" 2>/dev/null; then
    echo -e "${RED}âœ— Emdashes (â€”) found in documentation (violates core canon)${NC}"
    ((ERRORS++))
fi

# Validate reST files
if command -v rstcheck >/dev/null 2>&1; then
    for file in $CHANGED_FILES; do
        if [[ "$file" == *.rst ]]; then
            if ! rstcheck "$file" 2>&1; then
                echo -e "${RED}âœ— reST validation failed: $file${NC}"
                ((ERRORS++))
            fi
        fi
    done
else
    echo -e "${YELLOW}âš  rstcheck not installed (pip install rstcheck)${NC}"
fi

# Validate OpenAPI files
if command -v swagger-cli >/dev/null 2>&1; then
    for file in $CHANGED_FILES; do
        if [[ "$file" == *.yaml ]] || [[ "$file" == *.yml ]]; then
            if [[ "$file" == api-specs/* ]]; then
                if ! swagger-cli validate "$file" 2>&1; then
                    echo -e "${RED}âœ— OpenAPI validation failed: $file${NC}"
                    ((ERRORS++))
                fi
            fi
        fi
    done
else
    echo -e "${YELLOW}âš  swagger-cli not installed (npm install -g @apidevtools/swagger-cli)${NC}"
fi

# Validate Markdown files
if command -v markdownlint >/dev/null 2>&1; then
    for file in $CHANGED_FILES; do
        if [[ "$file" == *.md ]]; then
            if ! markdownlint "$file" 2>&1; then
                echo -e "${RED}âœ— Markdown validation failed: $file${NC}"
                ((ERRORS++))
            fi
        fi
    done
else
    echo -e "${YELLOW}âš  markdownlint not installed (npm install -g markdownlint-cli)${NC}"
fi

# Summary
if [ $ERRORS -gt 0 ]; then
    echo -e "\n${RED}Pre-commit validation FAILED${NC}"
    echo "Fix errors before committing."
    exit 1
else
    echo -e "\n${GREEN}Pre-commit validation PASSED${NC}"
    exit 0
fi
